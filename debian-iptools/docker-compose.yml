services:
  # Primary interactive toolbox
  iptoolkit:
    container_name: iptoolkit
    build:
      context: .
      dockerfile: Dockerfile
      args:
        HTTP_PROXY: "${HTTP_PROXY:-}"
        HTTPS_PROXY: "${HTTPS_PROXY:-}"
    image: debian-iptools:latest
    hostname: "${HOSTNAME_OVERRIDE:-iptoolkit}"
    network_mode: "host"
    cap_add:
      - NET_ADMIN
      - NET_RAW
    environment:
      TZ: "${TZ:-UTC}"
      TERM: xterm-256color
    volumes:
      - vnstat-db:/var/lib/vnstat
      - ./work:/work
    healthcheck:
      test: ["CMD-SHELL", "ping -c1 8.8.8.8 >/dev/null 2>&1 || exit 1"]
      interval: 30s
      timeout: 5s
      retries: 3
    stdin_open: true
    tty: true
    restart: unless-stopped
    profiles: ["default"]

  # Background iperf3 server
  iperf3-server:
    container_name: iperf3-server
    image: "${IMAGE_NAME:-iptoolkit}:${IMAGE_TAG:-debian-slim}"
    network_mode: "host"
    cap_add:
      - NET_ADMIN
    command: ["iperf3", "-s", "-p", "${IPERF_PORT:-5201}"]
    restart: unless-stopped
    profiles: ["perf"]

  # Continuous background capture
  tshark-capture:
    container_name: tshark-capture
    image: "${IMAGE_NAME:-iptoolkit}:${IMAGE_TAG:-debian-slim}"
    network_mode: "host"
    cap_add:
      - NET_ADMIN
      - NET_RAW
    command:
      [
        "tshark",
        "-i", "${CAP_IFACE:-any}",
        "-b", "files:10",
        "-b", "filesize:100000",
        "-w", "/captures/cap.pcap"
      ]
    volumes:
      - ./captures:/captures
    restart: unless-stopped
    profiles: ["capture"]

volumes:
  vnstat-db: